{
  "version": 2,
  "runs": {
    "db2368b7-9660-42b5-8def-2944e7552354": {
      "runId": "db2368b7-9660-42b5-8def-2944e7552354",
      "childSessionKey": "agent:coder:subagent:621a659a-fe25-4b5e-b20a-fe30583f5bf8",
      "requesterSessionKey": "agent:main:whatsapp:direct:+556299776996",
      "requesterOrigin": {
        "channel": "whatsapp",
        "to": "+556299776996",
        "accountId": "default"
      },
      "requesterDisplayKey": "agent:main:whatsapp:direct:+556299776996",
      "task": "## Task: Kiwify Webhook ‚Üí Mila Onboarding via WhatsApp\n**Projeto:** `/Users/mauricio/.openclaw/dashboard/`\n**Prioridade:** üî¥ Alta\n\n### Contexto\nMaur√≠cio quer que toda nova compra aprovada na Kiwify dispare automaticamente uma mensagem de boas-vindas pelo WhatsApp para o aluno, via agente Mila. O fluxo √©: Kiwify `compra_aprovada` ‚Üí webhook ‚Üí dashboard ‚Üí OpenClaw WhatsApp ‚Üí aluno.\n\n### Payload Kiwify (baseado no script kiwify_cli.py existente)\n```json\n{\n  \"event\": \"compra_aprovada\",\n  \"token\": \"<webhook_token_configurado_na_kiwify>\",\n  \"data\": {\n    \"id\": \"order_id\",\n    \"product\": { \"name\": \"TRINTAE3 - P√≥s em Sa√∫de Est√©tica Avan√ßada\" },\n    \"customer\": {\n      \"name\": \"Maria Silva\",\n      \"email\": \"maria@email.com\",\n      \"mobile\": \"5562999999999\"\n    },\n    \"status\": \"paid\"\n  }\n}\n```\n\n### O que implementar\n\n#### 1. Endpoint: `POST /api/webhooks/kiwify`\nCriar `src/server/routes/webhooks-kiwify.ts`:\n\n```typescript\nimport { Hono } from 'hono'\nimport { neon } from '@neondatabase/serverless'\n\nexport const kiwifyWebhookRoute = new Hono()\n\nkiwifyWebhookRoute.post('/', async (c) => {\n  const body = await c.req.json()\n\n  // Validar token do webhook (configurado no env como KIWIFY_WEBHOOK_TOKEN)\n  // Se token n√£o bater ‚Üí 401\n  const expectedToken = process.env.KIWIFY_WEBHOOK_TOKEN\n  if (expectedToken && body.token !== expectedToken) {\n    return c.json({ error: 'Invalid token' }, 401)\n  }\n\n  // S√≥ processar compra_aprovada\n  if (body.event !== 'compra_aprovada') {\n    return c.json({ ok: true, skipped: true })\n  }\n\n  const customer = body.data?.customer ?? {}\n  const product = body.data?.product ?? {}\n  const name = customer.name ?? 'aluno(a)'\n  const phone = customer.mobile ?? customer.phone ?? null\n  const email = customer.email ?? null\n  const productName = product.name ?? 'Grupo US'\n\n  if (!phone) {\n    console.warn('[kiwify-webhook] compra_aprovada sem phone:', email)\n    return c.json({ ok: true, warning: 'no_phone' })\n  }\n\n  // 1. Salvar em NeonDB (tabela laura_memories) para rastreamento\n  const sql = neon(process.env.DATABASE_URL!)\n  await sql`\n    INSERT INTO laura_memories (content, metadata, created_at)\n    VALUES (\n      ${`Novo aluno ${name} comprou ${productName}`},\n      ${JSON.stringify({ type: 'new_student', name, phone, email, product: productName, source: 'kiwify_webhook' })}::jsonb,\n      NOW()\n    )\n  `\n\n  // 2. Disparar mensagem de boas-vindas via OpenClaw WhatsApp\n  // OpenClaw CLI: `openclaw message send --channel whatsapp --target <phone> --message \"<text>\"`\n  // Usar exec no Bun para chamar o CLI\n  const { spawn } = await import('node:child_process')\n  const firstName = name.split(' ')[0]\n  const welcomeMsg = buildWelcomeMessage(firstName, productName)\n\n  await new Promise<void>((resolve, reject) => {\n    const proc = spawn('openclaw', [\n      'message', 'send',\n      '--channel', 'whatsapp',\n      '--target', phone,\n      '--message', welcomeMsg\n    ], { stdio: 'inherit' })\n    proc.on('close', (code) => code === 0 ? resolve() : reject(new Error(`openclaw exit ${code}`)))\n    proc.on('error', reject)\n  })\n\n  return c.json({ ok: true, phone, name, product: productName })\n})\n\nfunction buildWelcomeMessage(firstName: string, productName: string): string {\n  return `Oi ${firstName}! üíú Que alegria ter voc√™ aqui!\n\nSou a Mila, da equipe do Grupo US. Sua matr√≠cula em *${productName}* foi confirmada com sucesso! üéâ\n\nAqui vai o que voc√™ precisa saber para come√ßar:\n\n1Ô∏è‚É£ *Acesso √† plataforma*: voc√™ vai receber um e-mail com seu login e senha em breve. Caso n√£o chegue em at√© 1 hora, √© s√≥ me chamar aqui!\n\n2Ô∏è‚É£ *Nossa comunidade*: assim que acessar, entre no grupo de alunos ‚Äî √© l√° que acontece a troca de experi√™ncias, cases e novidades.\n\n3Ô∏è‚É£ *D√∫vidas*: pode me mandar mensagem aqui no WhatsApp a qualquer momento. Estou aqui para te apoiar em toda a sua jornada! üòä\n\nBem-vinda √† fam√≠lia Grupo US! Vai ser incr√≠vel. üöÄ`\n}\n```\n\n#### 2. Montar rota no servidor principal (`src/server/index.ts`)\n```typescript\nimport { kiwifyWebhookRoute } from './routes/webhooks-kiwify'\napp.route('/api/webhooks/kiwify', kiwifyWebhookRoute)\n```\n\n#### 3. Vari√°vel de ambiente\nAdicionar ao `.env` local (e ao Railway como vari√°vel de ambiente):\n```\nKIWIFY_WEBHOOK_TOKEN=<a_definir_pelo_mauricio>\n```\nNo c√≥digo, se `KIWIFY_WEBHOOK_TOKEN` n√£o estiver definido, logar aviso mas N√ÉO rejeitar (para facilitar testes iniciais).\n\n#### 4. Adicionar instru√ß√£o de configura√ß√£o ao TOOLS.md do agente mila\nCriar ou atualizar `/Users/mauricio/.openclaw/agents/mila/workspace/TOOLS.md` adicionando:\n```markdown\n## üéì Onboarding Autom√°tico ‚Äî Kiwify Webhook\n\nWebhook configurado na Kiwify:\n- URL: `https://laura.gpus.me/api/webhooks/kiwify`\n- Trigger: `compra_aprovada`\n- Token: (ver vari√°vel KIWIFY_WEBHOOK_TOKEN no Railway)\n\nQuando um aluno compra:\n1. Kiwify chama o webhook\n2. Dashboard valida token e extrai nome + telefone\n3. Mila envia mensagem de boas-vindas automaticamente via WhatsApp\n4. Registro salvo em laura_memories (NeonDB)\n```\n\n#### 5. Criar `src/server/routes/webhooks-kiwify.test.ts` (b√°sico)\n```typescript\n// smoke test: payload v√°lido retorna { ok: true }\n// payload sem phone retorna { ok: true, warning: 'no_phone' }\n// evento diferente de compra_aprovada retorna { ok: true, skipped: true }\n```\n\n#### 6. Quality gates + deploy\n```bash\ncd /Users/mauricio/.openclaw/dashboard\nbun run type-check\nbun run lint:check\ngit add -A\ngit commit -m \"feat: kiwify webhook ‚Üí mila onboarding whatsapp autom√°tico\"\ngit push origin main\n```\n\n### Handoff ao concluir\n1. URL final: `https://laura.gpus.me/api/webhooks/kiwify`\n2. Instru√ß√µes para Maur√≠cio configurar na Kiwify (painel Apps ‚Üí Webhooks ‚Üí Criar Webhook)\n3. Vari√°vel `KIWIFY_WEBHOOK_TOKEN` que Maur√≠cio deve configurar no Railway\n4. Issues conhecidas (ex: openclaw CLI no Railway?)\n5. Confirmar que rota est√° respondendo 200\n\n### ‚ö†Ô∏è Aten√ß√£o importante\nO `openclaw` CLI pode n√£o estar dispon√≠vel no Railway (ambiente de produ√ß√£o). Se o spawn falhar, fazer fallback: salvar em NeonDB com `status: 'pending_send'` e criar uma rota que a Laura (agente main) pode consultar periodicamente para enviar mensagens pendentes. Documentar no handoff.",
      "cleanup": "keep",
      "expectsCompletionMessage": true,
      "spawnMode": "run",
      "label": "kiwify-webhook-mila-onboarding",
      "model": "anthropic/claude-sonnet-4-6",
      "runTimeoutSeconds": 600,
      "createdAt": 1772125230793,
      "startedAt": 1772125230865,
      "archiveAtMs": 1772128830793,
      "cleanupHandled": true,
      "endedAt": 1772125351618,
      "outcome": {
        "status": "ok"
      },
      "endedReason": "subagent-complete",
      "endedHookEmittedAt": 1772125351940,
      "cleanupCompletedAt": 1772125351940
    }
  }
}
