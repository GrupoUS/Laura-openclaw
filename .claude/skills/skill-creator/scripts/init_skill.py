#!/usr/bin/env python3
"""
Skill Initializer - Creates a new skill from template

Usage:
    init_skill.py <skill-name> --path <path>

Examples:
    init_skill.py my-new-skill --path skills/public
    init_skill.py my-api-helper --path skills/private
    init_skill.py custom-skill --path /custom/location
"""

import sys
import re
from pathlib import Path


def is_valid_kebab_case(name):
    if not re.match(r"^[a-z0-9-]+$", name):
        return (
            False,
            f"Name '{name}' must contain only lowercase letters, digits, and hyphens",
        )
    if name.startswith("-") or name.endswith("-") or "--" in name:
        return (
            False,
            f"Name '{name}' cannot start/end with hyphen or contain consecutive hyphens",
        )
    return True, None


SKILL_TEMPLATE = """---
name: {skill_name}
description: TODO Write a trigger-oriented description starting with "Use when..." Example: "Use when creating a new skill, initializing a skill directory, or generating skill templates." Keep it under 1024 characters.
---

# {skill_title}

## Overview

[TODO: 1-2 sentences explaining what this skill enables]

## When to Use

[TODO: List specific scenarios, file types, or tasks that trigger this skill]

## Core Pattern

[TODO: Show the main pattern or workflow this skill provides]

## Implementation

[TODO: Add detailed implementation guidance, code examples, or step-by-step instructions]

## Resources

This skill may include example resource directories:

### scripts/
Optional executable code (Python/Bash/etc.). Delete if not needed.

### references/
Optional documentation to load into context. Delete if not needed.

### assets/
Optional files for output (templates, images, etc.). Delete if not needed.

---

Delete any unneeded directories. This is a starting point, not a complete skill.
"""

EXAMPLE_SCRIPT = '''#!/usr/bin/env python3
"""Example script for {skill_name}. Delete if not needed."""

def main():
    print("Example script for {skill_name}")
    # TODO: Add actual script logic here

if __name__ == "__main__":
    main()
'''

EXAMPLE_REFERENCE = """# Reference for {skill_title}

Delete this file if not needed. Use for detailed documentation too lengthy for SKILL.md.
"""

EXAMPLE_ASSET = """# Placeholder for {skill_name} assets

Delete this file if not needed. Add templates, images, fonts, or other files here.
"""


def title_case_skill_name(skill_name):
    """Convert hyphenated skill name to Title Case for display."""
    return " ".join(word.capitalize() for word in skill_name.split("-"))


def init_skill(skill_name, path):
    """
    Initialize a new skill directory with template SKILL.md.

    Args:
        skill_name: Name of the skill
        path: Path where the skill directory should be created

    Returns:
        Path to created skill directory, or None if error
    """
    # Validate skill name is kebab-case
    valid, error = is_valid_kebab_case(skill_name)
    if not valid:
        print(f"‚ùå Error: {error}")
        return None

    # Determine skill directory path
    skill_dir = Path(path).resolve() / skill_name

    # Check if directory already exists
    if skill_dir.exists():
        print(f"‚ùå Error: Skill directory already exists: {skill_dir}")
        return None

    # Create skill directory
    try:
        skill_dir.mkdir(parents=True, exist_ok=False)
        print(f"‚úÖ Created skill directory: {skill_dir}")
    except Exception as e:
        print(f"‚ùå Error creating directory: {e}")
        return None

    # Create SKILL.md from template
    skill_title = title_case_skill_name(skill_name)
    skill_content = SKILL_TEMPLATE.format(
        skill_name=skill_name, skill_title=skill_title
    )

    skill_md_path = skill_dir / "SKILL.md"
    try:
        skill_md_path.write_text(skill_content)
        print("‚úÖ Created SKILL.md")
    except Exception as e:
        print(f"‚ùå Error creating SKILL.md: {e}")
        return None

    # Create resource directories with example files
    try:
        # Create scripts/ directory with example script
        scripts_dir = skill_dir / "scripts"
        scripts_dir.mkdir(exist_ok=True)
        example_script = scripts_dir / "example.py"
        example_script.write_text(EXAMPLE_SCRIPT.format(skill_name=skill_name))
        example_script.chmod(0o755)
        print("‚úÖ Created scripts/example.py")

        # Create references/ directory with example reference doc
        references_dir = skill_dir / "references"
        references_dir.mkdir(exist_ok=True)
        example_reference = references_dir / "api_reference.md"
        example_reference.write_text(EXAMPLE_REFERENCE.format(skill_title=skill_title))
        print("‚úÖ Created references/api_reference.md")

        # Create assets/ directory with example asset placeholder
        assets_dir = skill_dir / "assets"
        assets_dir.mkdir(exist_ok=True)
        example_asset = assets_dir / "example_asset.txt"
        example_asset.write_text(EXAMPLE_ASSET.format(skill_name=skill_name))
        print("‚úÖ Created assets/example_asset.txt")
    except Exception as e:
        print(f"‚ùå Error creating resource directories: {e}")
        return None

    # Print next steps
    print(f"\n‚úÖ Skill '{skill_name}' initialized successfully at {skill_dir}")
    print("\nNext steps:")
    print("1. Edit SKILL.md to complete the TODO items and update the description")
    print(
        "2. Customize or delete the example files in scripts/, references/, and assets/"
    )
    print("3. Run the validator when ready to check the skill structure")

    return skill_dir


def main():
    if len(sys.argv) < 4 or sys.argv[2] != "--path":
        print("Usage: init_skill.py <skill-name> --path <path>")
        print("\nSkill name requirements:")
        print("  - Hyphen-case identifier (e.g., 'data-analyzer')")
        print("  - Lowercase letters, digits, and hyphens only")
        print("  - Max 40 characters")
        print("  - Must match directory name exactly")
        print("\nExamples:")
        print("  init_skill.py my-new-skill --path skills/public")
        print("  init_skill.py my-api-helper --path skills/private")
        print("  init_skill.py custom-skill --path /custom/location")
        sys.exit(1)

    skill_name = sys.argv[1]
    path = sys.argv[3]

    print(f"üöÄ Initializing skill: {skill_name}")
    print(f"   Location: {path}")
    print()

    result = init_skill(skill_name, path)

    if result:
        sys.exit(0)
    else:
        sys.exit(1)


if __name__ == "__main__":
    main()
